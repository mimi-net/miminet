# README.md

## Модуль аутентификации Miminet

Этот Python-модуль, `miminet_auth.py`, предоставляет функции аутентификации для интеграции с сервисами Yandex и Telegram в приложении Miminet. В данном файле рассмотрены ключевые функции, а также подробно описана работа функции `check_tg_authorization(auth_data)`.

### Аутентификация через Yandex

#### `yandex_login()`

Эта функция инициирует процесс аутентификации через Yandex. Она генерирует URL авторизации и перенаправляет пользователя на Yandex для входа. После успешной аутентификации пользователь перенаправляется на обратный вызов от Yandex.

#### `yandex_callback()`

Эта функция обрабатывает обратный вызов от Yandex после успешной аутентификации пользователя. Она извлекает информацию о пользователе, проверяет срок действия токена и создает или обновляет пользователя в базе данных Miminet. Затем пользователь входит в систему, и приложение перенаправляет его на домашнюю страницу.

### Аутентификация через Telegram

#### `check_tg_authorization(auth_data)`

Эта функция предназначена для проверки подлинности и валидности данных аутентификации от Telegram. Ниже разъяснено, как работает каждая часть функции.

1. **Получение данных**

```python
check_hash = auth_data['hash']
del auth_data['hash']
```

- Извлекается хеш из данных аутентификации, а затем сам хеш удаляется из словаря `auth_data`. Хеш используется для проверки подлинности данных.

2. **Подготовка данных для проверки**

```python
data_check_arr = [f"{key}={value}" for key, value in auth_data.items()]
data_check_arr.sort()
data_check_string = "\n".join(data_check_arr)
```

- Создается отсортированный массив строк, содержащих ключи и значения данных аутентификации. Этот массив строк сортируется, и затем строки объединяются в одну строку с символом новой строки между ними. Этот текст будет использован для проверки целостности данных.

3. **Подготовка ожидаемого хеша**

```python
secret_key = hashlib.sha256(BOT_TOKEN.encode()).digest()
hash_result = hmac.new(secret_key, data_check_string.encode(), hashlib.sha256).hexdigest()
```

- Создается секретный ключ из токена Telegram бота (`BOT_TOKEN`).
- Вычисляется хеш данных аутентификации с использованием созданного секретного ключа.

4. **Проверка хеша**

```python
if hash_result != check_hash:
    raise Exception('Data is NOT from Telegram')
```

- Сравнивается вычисленный хеш с полученным хешем. Если они не совпадают, возбуждается исключение, указывающее на то, что данные не являются от Telegram.

5. **Проверка срока действия данных**

```python
if (time.time() - int(auth_data['auth_date'])) > 86400:
    raise Exception('Data is outdated')
```

- Проверяется, не устарели ли данные. Если прошло более 86400 секунд (24 часа) с момента аутентификации, возбуждается исключение о том, что данные устарели.

6. **Успешная аутентификация**

```python
print("Authorization successful")
return auth_data
```

- Если все проверки успешны, функция завершает свою работу, возвращая исходные данные аутентификации.

7. **Обработка ошибок**

```python
except Exception as e:
    print(f"Authorization failed: {str(e)}")
    raise
```

- В случае возникновения любой ошибки в процессе аутентификации, функция выведет сообщение об ошибке и повторно возбудит исключение, чтобы уведомить вызывающий код.

### Обработка обратного вызова от Telegram

#### `tg_callback()`

Эта функция обрабатывает обратный вызов от Telegram после успешной аутентификации пользователя. Она проверяет данные Telegram пользователя, создает или обновляет пользователя в базе данных Miminet и входит в систему пользователя. Приложение затем перенаправляет пользователя на домашнюю страницу.

### Интеграция с Yandex и Telegram в HTML

Файл `login.html` содержит кнопки для аутентификации через Yandex и Telegram. Аутентификация через Yandex запускается нажатием кнопки Yandex, а аутентификация через Telegram осуществляется с использованием виджета Telegram. Виджет вызывает функцию JavaScript `onTelegramAuth`, которая обрабатывает аутентификацию и перенаправляет пользователя на обратный вызов Telegram.